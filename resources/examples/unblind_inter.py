#!/usr/bin/env python

import pickle, math
import numpy as np
from icecube import MLSandboxPythonAccess
from optparse import OptionParser
from scipy import stats, integrate

#Here we create some binned expectations (PDFs) for our binned likelihood
def create_expectations():
    from scipy import stats
    bins= 1000
    x = np.linspace(0,10,bins)
    #Our background is an exponential
    bg = np.ones(bins)*stats.expon.pdf(x,scale = 5)
    #Our signal is a gaussian
    sig = stats.norm.pdf(x, loc = 4, scale=0.51)
    sig = [ 0.00060406 ,0.00080264 ,0.0010163  ,0.00116361 ,0.00128615 ,0.00124071
               ,0.00138187 ,0.00156202 ,0.00161081 ,0.00175798 ,0.00190009 ,0.00215668
               ,0.00219562 ,0.0030128  ,0.00324784 ,0.00419621 ,0.00447374 ,0.00601403
               ,0.00705413 ,0.00865936 ,0.01097375 ,0.01383146 ,0.01770544 ,0.02445783
               ,0.03454638 ,0.04826891 ,0.06830304 ,0.08074848 ,0.06951341 ,0.03497105]

    bg = [ 0.0093132  ,0.01098544 ,0.00930439 ,0.01257388 ,0.01386533 ,0.01147893
              ,0.01411636 ,0.01724433 ,0.01565167 ,0.01502858 ,0.01628498 ,0.01639443
              ,0.01958742 ,0.01975108 ,0.01917875 ,0.01929589 ,0.01917206 ,0.02132125
              ,0.0185124  ,0.01934467 ,0.01829545 ,0.01681847 ,0.01790569 ,0.01573036
              ,0.01638429 ,0.01436382 ,0.01107329 ,0.0094507  ,0.00755053 ,0.00515247]


    #sig =  [0.00060406,  0.00080264,  0.0010163,   0.00116361,  0.00128615,  0.00124071, 0.00138187,  0.00156202,  0.00161081,  0.00175798,  0.00190009,  0.00215668, 0.00219562,  0.0030128, 0.00324784,  0.00419621,  0.00447374,  0.00601403,
    #      0.00705413,  0.00865936,  0.01097375,  0.01383146,  0.01770544,  0.02445783,
    #      0.03454638,  0.04826891,  0.06830304,  0.08074848,  0.06951341,  0.03497105]

    #bg = [ 0.0093132,   0.01098544,  0.00930439,  0.01257388,  0.01386533,  0.01147893,
    #            0.01411636,  0.01724433,  0.01565167,  0.01502858,  0.01628498,  0.01639443,
    #            0.01958742,  0.01975108,  0.01917875,  0.01929589,  0.01917206,  0.02132125,
    #            0.0185124 ,  0.01934467,  0.01829545,  0.01681847,  0.01790569,  0.01573036,
    #            0.01638429,  0.01436382,  0.01107329,  0.0094507,   0.00755053,  0.00515247]
    bins = [ 114.59155903 ,116.77184039 ,118.95212176 ,121.13240312 ,123.31268449
                            ,125.49296586 ,127.67324722 ,129.85352859 ,132.03380995 ,134.21409132
                            ,136.39437268 ,138.57465405 ,140.75493542 ,142.93521678 ,145.11549815
                            ,147.29577951 ,149.47606088 ,151.65634224 ,153.83662361 ,156.01690498
                            ,158.19718634 ,160.37746771 ,162.55774907 ,164.73803044 ,166.91831181
                            ,169.09859317 ,171.27887454 ,173.4591559  ,175.63943727 ,177.81971863
                            ,180.]
    bw = (max(bins) - min(bins)) / len(sig)
    x = np.linspace(bins[0]+bw/2,180.0-bw/2,len(sig))
    return (sig,bg,x, bins)

def setup_llh(sig, bg, x,  N, seed):
    print(len(sig), min(x)-.5, max(x)+.5)
    sig_exp = MLSandboxPythonAccess.Distribution(sig, min(x), max(x), 1)
    bg_exp = MLSandboxPythonAccess.Distribution(bg, min(x), max(x), 1)
    sig_exp.SetCDFSampling(True)
    bg_exp.SetCDFSampling(True)
    llh = MLSandboxPythonAccess.Likelihood.BinnedLikelihood.ShapeLikelihood(sig_exp, bg_exp, sig_exp, bg_exp, N, seed)
    return llh

def load_expectations(sig_file, bg_file):
    '''Test data provided by mzoll (solar wimp pdfs)
    '''
    import pickle
    fs = open(sig_file,'r')
    fd = open(bg_file,'r')
    sig = pickle.load(fs)
    bg = pickle.load(fd)
    x = np.linspace(0,179,len(sig))+0.5
    return (sig,bg,x)

def compute_sensitivity(options):
    exp = [146.9996480984383, 155.80945502216255, 118.14459092686957, 131.60224927891494, 131.77169212510873, 166.34415708362158, 157.55655230781446, 116.7468761586293, 158.32816073879877, 160.84812115802475, 146.87694527598018, 143.74376214669022, 144.06975000836997, 163.48696472303197, 163.92531326670965, 179.34573310967204, 136.83609782723516, 149.40012109682306, 157.3268437012993, 135.3171914900014, 164.44880800594086, 127.62132119359818, 165.57066416816002, 140.15766579514914, 141.29424429845324, 142.26335427238087, 168.57591771614676, 161.78270161191907, 163.72995153182887, 168.68687328373872, 154.94937033788491, 134.52776460924505, 158.78443560487037, 140.61196916246868, 135.9878128434999, 161.03491134163835, 122.95227873690972, 150.72598612388006, 155.27609931539013, 133.621171543248, 143.5644021185148, 155.18921612979332, 160.42967274613218, 134.4629368166278, 143.06919302653557, 152.39353361912603, 151.86398169792307, 135.8933739149136, 160.08860994582815, 129.43078355535943, 160.19808998612615, 163.70750456564184, 163.12553841726316, 153.45456707809578, 123.28919483311783, 158.49711261861577, 163.7221197736135, 148.24145107910468, 150.89255584011119, 143.26234930894285, 150.9156524068809, 145.4256158036414, 155.70601622287708, 162.05455818107197, 121.7713730205027, 117.41027721964137, 165.73474981775792, 136.1719352495869, 160.1111770463869, 139.5437172482765, 169.3736197647115, 167.97704504819956, 160.10407825882348, 127.65576597129612, 138.45716152921656, 162.54922797923965, 141.20074983736257, 152.96134250357525, 147.30257661192934, 173.08164338814797, 143.75043454805584, 146.5512814497113, 138.27473763372942, 154.20523837314767, 169.222747673099, 119.83568389879063, 153.82056561906006, 155.80675892813395, 170.8780404559429, 129.6672200317036, 157.6896274363727, 130.3460850474495, 173.4411825991357, 139.063661463231, 145.54539858537782, 132.55426009517055, 140.84753647424097, 149.56675160728201, 146.7001449339646, 147.64548943748105, 141.3602333701001, 172.33619192169206, 174.08976472570274, 154.97150522022883, 140.1752251403427, 148.32593205350108, 144.07373366385463, 142.2989345383172, 150.2271342732358, 167.87103147260427, 130.79434611460107, 151.37227207118283, 168.8959114734735, 162.3054469867376, 147.60268850471772, 164.5814495153296, 145.63686038520507, 144.11065549332636, 143.626979764697, 129.4862512551258, 122.21127768241234, 152.39314292312557, 163.75441780938834, 134.76244019904343, 129.47935434899037, 120.35432210846052, 146.96571326957687, 164.98363494512972, 119.58568695906006, 166.6914156373146, 138.17797158406947, 144.95034054162159, 142.56777070936084, 142.2363891464428, 175.84942358946418, 126.13597163784756, 131.37661805669546, 140.2102343269947, 156.53544899953906, 133.6810599510556, 163.86972743634874, 151.09190330136732, 158.86901607789005, 132.20607527353644, 179.8849129829824, 167.1427277108336, 145.8203130648647, 166.3884524679022, 147.6328109362681, 146.74786798335106, 176.24728211217624, 142.12972600420338, 168.5231666464975, 147.8344397774527, 153.3957635015227, 146.53213199565454, 134.3949540831964, 130.60666634625346, 121.88285691567147, 164.70735093148042, 146.15489368544385, 132.91396272985645, 153.97371741839785, 147.6228929347022, 158.8396127780054, 157.541134465195, 143.94511202610454, 170.6228568213925, 133.40730999512917, 140.37808323365104, 127.22487440222689, 165.36644576793066, 152.82419497845643, 155.60063136258253, 119.04842807942354, 142.10040366799146, 123.11324772241731, 132.98283748186114, 145.52275884866194, 149.82604519675203, 158.14474141371133, 149.15723980200025, 127.9782522820074, 140.29469409205396, 155.78180752694405, 149.4275152292684, 160.98939795988622, 151.22483408294104, 135.26742310011147, 170.32772235936343, 154.10471035954504, 141.29968425388932, 155.35988111533223, 168.54957175101376, 132.2784820133085, 117.4051420405226, 150.34247849443253, 128.0898694646149, 166.636955585423, 145.74372125644877, 128.5718774323561, 141.29067473839916, 155.31798868979496, 144.92194495702518, 137.8264282858959, 132.51669854845994, 126.32016635473846, 122.27192815036778, 155.68994486158445, 136.25844317018363, 178.71156156638511, 136.04765415932636, 155.65897466984023, 141.2698392363743, 133.5532649999904, 134.12070938013804, 147.6853656309401, 154.29784419561804, 150.207972563714, 168.07083926008465, 132.92188231952423, 124.02358001063538, 131.39920912721342, 148.08192779915797, 173.0673959251911, 147.72954437802903, 145.78958967995138, 125.71869180812384, 159.60520760063167, 156.51218006114644, 125.4980265543905, 166.69516885202918, 167.44367000417895, 131.939959147513, 140.86487182770645, 165.6484536213417, 164.32143194522183, 142.9190739819396, 163.32580209219458, 142.3901098033817, 146.57398281649486, 151.84725620436973, 153.70775209733227, 169.45425050799784, 164.50610114378534, 151.46502831778167, 139.48568676071608, 133.84834374604964, 167.22231695746925, 132.63247516221892, 130.21202725843412, 130.67808185971518, 161.24128676682858, 138.50308321227783, 157.29711479665073, 155.61893834004107, 166.5556254151534, 151.34583998472468, 132.5205835724851, 137.55805295400165, 158.93381216919101, 149.6470073335002, 177.84098028158007, 134.06772656219744, 166.53399330339732, 121.09034115635318, 127.79523423220819, 166.944760464196, 166.03105447221733, 121.28199569109663, 137.58055934007726, 162.85512268923384, 146.0932743584117, 137.61676137245024, 132.86833128412988, 117.50875859658025, 148.6772395966528, 121.86460909890032, 178.04905831663402, 123.92629310497897, 115.88790820051068, 151.6309899099999, 127.12623964432971, 156.35961637724054, 144.1896602082776, 119.98909019118011, 117.32640786336742, 139.98827363699732, 122.90801419355942, 144.70755030769922, 156.75737776154634, 140.54490022444844, 159.2011056233409, 165.24238197545782, 150.52312062791796, 171.94928128232104, 163.44980522631545, 147.73511242211825, 125.00889963223626, 172.91114035863163, 150.55248312615197, 124.22818529730208, 148.56139642786422, 144.89200561806447, 156.9622706405345, 166.29465836276668, 140.5014490297152, 166.82477358336945, 152.33020741044226, 153.60088209653955, 157.24936742561988, 154.0995690030901, 161.79951462166298, 129.39582400451775, 132.03366401850232, 150.7573880335669, 143.09902348990389, 151.74059126113877, 163.56552785997087, 149.18615420959753, 150.73838273598366, 135.79957248446684, 119.88944693913842, 171.7518254993643, 156.4674062492484, 152.23776026818695, 162.86520569508718, 145.09785800649922, 165.5698473205549, 156.09850101969414, 152.64352941178538, 129.61587077263778, 116.60948898840236, 145.85568493173403, 141.2018354801091, 153.02853596243645, 162.67523268717235, 151.61451438187393, 121.43787824146423, 173.005562439542, 148.2550280548185, 145.9009705128432, 147.68547748043125, 135.903181975486, 114.69389580056215, 159.1903663902825, 166.03241482637242, 165.63856185770095, 160.0461967443622, 165.82518199995178, 150.5558371434057, 156.33978662223075, 153.018154288814, 119.38170913817261, 141.8134760212549, 145.2165363085928, 167.2630673918878, 140.30661398156883, 127.95194318381856, 155.47886340742826, 134.37536168809677, 149.04300147031267, 163.12360919402533, 148.6660632765013, 132.84292481097307, 140.2404298920072, 139.24836475269743, 160.19296646260338, 171.68869917628408, 156.7306979642794, 148.85769534759328, 157.63519762545292, 125.97453917456572, 147.2087046388371, 146.8764525001854, 142.49103516215243, 155.00532661938215, 153.66418996358107, 153.85797969633813, 149.35859699860657, 161.45184528215032, 154.8121022243439, 148.86406592125795, 159.45570952479846, 149.1700264426715, 142.60993769016883, 127.8045356123939, 137.82943192985215, 175.48498970386487, 127.97135812311079, 140.53648574382274, 132.988692233904, 131.54642290576203, 142.70951356815422, 119.73263008782519, 168.567494835937, 142.75371819297015, 148.90337912285537, 132.0049783252415, 146.31635613863017, 134.2650785612287, 147.38755273525217, 151.50381507519168, 153.30743956866837, 170.78132996215447, 174.21242179216281, 133.16719259019774, 133.34368299199474, 124.2494258861701, 147.98690479183492, 144.82292454447662, 150.33784671825586, 148.50126146841325, 162.50887644337257, 145.66946422856623, 151.07149859924922, 137.9439647566098, 148.4126013949956, 137.36692951400948, 142.52839249708208, 142.84269284804964, 125.79257101161399, 155.11070836269528, 148.43371479415916, 160.6777894241067, 155.07092439124304, 173.56970523504825, 154.44413988057175, 162.93320240857634, 120.56982002315867, 162.4886392416924, 147.709691322711, 165.32633262567762, 155.9783560044778, 128.3286114203767, 155.35574619089905, 142.77909261760658, 120.94348477691044, 154.50249473383013, 121.66873277062903, 146.99199148803592, 148.30275776578412, 174.11582988497298, 131.12350262325572, 160.6686661830876, 130.01480722355217, 161.21672330588544, 151.53637060854751, 145.09513402542322, 167.2624657057549, 134.03754939552445, 140.44898118118263, 157.07618564273352, 159.07699379352886, 131.04456689779676, 143.8958196593289, 157.1090131406636, 145.35380583259487, 155.80340173961898, 152.92715259224374, 144.89241708632485, 127.3972739933478, 161.34363007444148, 153.37343840132652, 128.3827642919972, 135.27229015393328, 166.37525307912412, 137.2457913365226, 169.96139538884515, 158.1064882105145, 135.45232984810005, 125.49478519522484, 135.82541899044892, 133.63180503723675, 157.7971525378114, 127.20213502107357, 124.92010801384944, 119.11410891963456, 172.80813053739996, 128.16887794472285, 160.36855353775613, 161.24986242667774, 146.79514231189785, 157.60405228241143, 142.72108259413696, 162.9796473175075, 161.6854369648337, 165.5688373888316, 154.79798874025607, 146.7655457492113, 143.27708293817363, 134.00029659929064, 153.70409740393922, 146.1776676594864, 137.43756770003682, 121.13949638796353, 163.51156618271983, 121.57845435625968, 134.20229884519625, 122.69101455345462, 125.20423857036754, 172.2117159838929, 172.32606403776674, 135.69965718927892, 147.54598019364096, 168.3894392776442, 174.4650517709625, 153.7655278397998, 147.42860032281527, 122.33131008317507, 131.5707954312436, 156.19825973381023, 133.56185624447326, 122.35104983880908, 161.55399076133952, 150.7887189262703, 129.7069963789071, 119.84144303918451, 154.05207673982284, 142.3881655588261, 143.68111294708655, 119.39276721272319, 136.53473769362094, 136.39847364207372, 163.5464069173545, 137.8277140771307, 131.53785208418918, 118.29949751797001, 155.31105333891173, 135.14623979356728, 154.53002877900244151090885, 159.3268183970476, 172.56483782730666, 160.1621502137542, 154.42164116232416, 156.91153125683488, 170.30122524234375, 155.58849482764464, 179.8922341077428, 122.05579189501579, 119.17290461592424, 168.03673440339338, 153.68045491057495, 140.8208849961807, 127.58107605185124, 173.6986092230042, 169.27047503821714, 169.0185216908631, 157.5582173442892, 143.6592094857961, 141.36622401479204, 134.36789608614805, 128.97498750232523, 164.15869752345236, 117.61188628569163, 160.73098845772486, 159.42299204879507, 142.38755155738906, 125.4971203593384, 140.865072529269, 133.17915438660503, 168.629969043747, 136.70487217912446, 119.34549096241665, 140.75189478567495, 148.79731471433112, 143.15304918811546, 152.37867138164833, 151.20984035060906, 125.73624015071698, 144.92605969139896, 146.72738782476483, 156.00993737001926, 126.91516946872265, 157.50781539336836, 127.97567475633717, 150.68758839474017, 136.94637176183085, 145.5456414560031, 154.86522275729897, 119.50086114302376, 176.98008584867955, 146.9461229447048, 145.25829203594344, 152.24576116926363, 123.97222479597184, 144.3976441410904, 169.33303944984095, 154.90270609110772, 156.12669897621456, 143.4528880189143, 160.07097168788354, 158.60987670161896, 148.42410895278056, 141.7338092838415, 126.77026062050791, 153.0492484694479, 142.57100170857058, 166.13390776829945, 170.14058835330096, 158.58272612579697, 164.28158363642166, 149.71268035610103, 168.48980796838293, 123.18465518952873, 153.71859426273284, 118.96228627121154, 162.52949462073167, 137.58092428018705, 162.90399925177135, 132.04071135934615, 147.11144487126396, 159.53975243509834, 142.3131700445128, 143.13630461637234, 120.95528386223103, 160.21959550429645, 116.25423093387438, 139.09978118543367, 137.75109386546475, 150.58031042787962, 129.63104684326774, 122.32448947114533, 156.67181523488546, 131.43214444249358, 144.10315504962907, 169.46455342770707, 129.0023561287254, 132.09662314386512, 138.0105260153192, 164.600887270073, 154.64521434606073, 141.31541829015814, 128.94219178220158, 151.6521213054084, 160.23705428078188, 176.51340356682942, 134.35803326204783, 139.31328203877428, 172.9835662303584, 139.52244402790663, 156.40380102195257, 148.19496863023429, 155.45495107876735, 126.94066690033904, 156.93331448239027, 169.5333411927612, 157.33173066965168, 125.79222936331091, 137.26116537857865, 154.11699572066235, 123.50598753645103, 168.78556882328581, 134.81386019322414, 147.96515906936233, 117.45498839165184, 161.74486706505553, 131.76788993482253, 139.93385088685696, 130.72819086179456, 176.26775449795733, 149.55369013558894, 151.2768654015428, 129.5160848602125, 162.27199194521828, 158.53131610436182, 153.6518957235117, 139.46100804818087, 132.79575900598337, 136.27192892705474, 161.97753993053874, 139.87816070962745, 148.3834772703701, 121.0731739352343, 134.01360611802994, 148.21835713647522, 117.1678178950672, 147.7403721225377, 160.71365013437853, 142.45103783218195, 174.85164756637667, 171.6098024082391, 167.7767506224921, 137.4137352704651, 116.02070457730349, 138.5635785399683, 131.0152663519308, 153.5146483906658, 164.6860816159061, 142.623473483997, 147.0159133729107, 129.20211528949346, 147.07997222263117, 143.9315417813946, 151.23358080608625, 154.11937331882345, 155.0523593403152, 152.49412205984873, 152.44612855526438, 150.58477189042827, 167.30634445185618, 144.1076350031827, 140.57760263443288, 152.36019594483608, 134.11679601496388, 123.49468744701234, 134.17929660534406, 147.56191904830558, 120.07564822508965, 157.74648026666813, 127.41802544533377, 145.85412629349403, 131.71716786091872, 127.79697816804998, 133.6993337466872, 179.44239307176844, 140.40976738162414, 175.09636008594316, 162.10691938058764, 170.57503848186056, 158.7488598663819, 125.51682109701501, 133.5820629425321, 172.45405310391158, 163.04198104764464, 152.23238863478858, 132.6586520526954, 160.75679291536883, 136.90638368474208, 150.7075917652471, 163.81193086936642, 160.7580370333895, 155.38014446692173, 147.0555065482919, 139.13549409815062, 121.56218549549894, 148.85037290885117, 133.89670248142156, 146.25002583838952, 138.03563390561865, 172.21102250171398, 127.88247013193636, 141.8671913665811, 154.00124348744265, 124.648817370084, 153.48592097424114, 176.6320891438185, 161.64211966766726, 136.36405040530948, 154.3944233257232, 142.51996649716386, 144.54034257220638, 157.5116470213813, 163.53832967983683, 137.63769148186032, 162.6704955126686, 145.64348257026185, 151.15272713322017, 118.02322408783607, 161.22071262029306, 150.02511044005144, 144.96417599420388, 127.26197604104696, 172.97956584858363, 155.87044620391237, 165.30950011037058, 156.59151048997097, 140.49596583225087, 136.93600413100955, 144.1720147766477, 147.32526085411405, 141.6193775584023, 150.39791506294964, 134.11895102781745, 124.92375230411369, 123.6946443394648, 148.9512411480862, 167.3766725032442, 145.27221913574914, 117.22705059505851, 175.26309737493324, 159.2712198805961, 137.72889722058437, 166.1050371800229, 139.6784480065506, 133.126902191992, 119.2947534316334, 141.84023517988868, 128.84474249136466, 170.92479280761594, 157.94881461815277, 139.1175964237685, 164.32355854871633, 171.59372727810361, 159.0042621899475, 139.0675189192223, 169.08968443248065, 121.82375723822237, 148.2399646768125, 139.02850652805085, 165.53895439445276, 124.35501323802238, 151.1627865647995, 161.25482125935073, 140.64003324222836, 160.3608744622575, 163.71603611000398, 165.62375600216646, 122.15330171898042, 162.02697455138747, 142.50250964798332, 156.71077823958356, 146.03936518037057, 147.69259444138117, 143.93749195098863, 152.48536455821107, 167.98773966169736, 149.61704339125808, 120.52831083373434, 128.3878677631403, 126.14678835801195, 127.58562288513289, 129.82193298465018, 158.37233680425334, 136.0220373161194, 170.94708961348945, 155.14823696362203, 155.0726649600738, 147.41833690302664, 156.4304803460593, 134.91004352135118, 144.20531812697655, 174.02734015317094, 122.9098986247661, 149.54410850674378, 123.12094561176949, 147.59261337022278, 152.17347262593523, 161.3817547616509, 166.62937068565836, 161.84588407447993, 140.98194809352538, 152.92300450931336, 162.25438760129165, 121.02352130862111, 165.4543872245973, 118.094082819783, 121.66405934975712, 172.25368490461227, 169.13702769570676, 167.0241614647456, 129.3292357778258, 130.91854545534017, 152.16589272413103, 130.07662250987434, 173.58070767811958, 136.38875237523382, 137.7651442084655, 126.44528783072872, 172.76056591091233, 134.1945553591158, 165.8689675534563, 153.38678140286362, 145.0140378381946, 136.19539514898585, 152.4122722329825, 157.22350440415008, 165.79514794801068, 161.5616055723093, 143.259333002668, 154.30798595132757, 150.57283491551397, 144.3964707567527, 122.39325811187057, 166.9407823439324, 162.39269614696303, 163.29415400699264, 128.48338043549205, 165.1199082752493, 159.3524469858374, 165.17769462826166, 138.5881906037138, 139.45614989343738, 146.02779251185493, 118.89247487383159, 144.50089648410898, 145.65902404217178, 151.24504985831476, 171.8015823762671, 135.03748037873848, 131.70981985384074, 147.92902091942867, 130.9186928129958, 141.06103080193193, 153.92764269166827, 148.12871290815437, 174.72772829673508, 135.97682850932466, 123.58559266161102, 138.83645602619197, 132.88073040202184, 126.23969158565195, 163.11918798818613, 142.71517105211507, 144.08834286807675, 160.71127485215953, 156.146761410919, 133.43866740524444, 143.3162970761878, 158.78308077761466, 168.5017163948933, 137.85854715905668, 149.2567898064723, 168.73054061687645, 160.78389789441547, 166.14433423534223, 160.14197020012185, 146.99104136417913, 131.36770761565018, 155.79630385936096, 173.13946295592584, 171.36070735368958, 152.55546543935537, 149.0231916244217, 174.1126121832582, 127.86232051034955, 146.32258690616192, 168.14234079201805, 151.14977544235748, 142.1978446201658, 153.3272535893324, 129.90961917450286, 147.34504647299636, 144.32355932335798, 146.7633910725038, 152.22137702465, 126.25392529931572, 117.14413592393734, 129.5181405190667, 137.6299044572001, 135.46458962901386,168.04178106472207, 119.27745012081024, 138.01297784415198, 129.07526508493277, 161.5081378683991, 147.6293101458791, 151.55820973601564, 156.56950888773363, 128.3609786512433, 143.35514550499778, 120.64695454333675, 138.06397712486572, 171.25521533189388, 140.6465567175599, 147.25808270314056, 145.3226678597742, 165.29939839753635, 160.11958304717922, 141.83636856183554, 147.00533587257, 129.78074871765986, 126.53324596599089, 155.23601705319058, 127.76681354724752, 141.0159487652568, 178.77641687636012, 143.42021416846285, 154.5286633871786, 143.75704854769666, 150.0287837453908, 161.60581489308748, 143.4487191150297, 171.57197717936086, 163.49202119549736, 159.99702169594474, 125.01847954269597, 129.985339975995, 153.77146830962073, 150.3153482529015, 174.00252015985865, 143.31464301834242, 117.88546822227369, 155.75038489455747, 136.7302670567467, 147.66225761021894, 141.827055943196, 134.42629610334268, 138.45745270952895, 148.83394254397092, 121.27273107367725, 131.9562757935864, 142.96541910943495, 170.58303741941788, 153.238709061505, 117.63515049913651, 125.62137702437175, 130.72456213998183, 143.4200102551323, 131.9599854474092, 128.68845240426168, 156.57811306260137, 142.40399642905288, 146.11115708118064, 139.34101105969555, 118.39875597116675, 134.35926295529205, 150.13823814496737, 147.8588038838961, 149.28100745698265, 135.78264690481757, 115.84215548923824, 146.49573533235065, 153.92737961954367, 160.498380735872, 124.88256526468467, 142.52117289524867, 147.94699696160012, 158.3777969469293, 163.17565540208048, 155.3489974839803, 163.81502444005295, 147.54583463436452, 160.95252021694887, 137.64868621391625, 167.16876546725425, 146.23479868721716, 165.52847324876055, 116.90522530023549, 137.26136018222803, 145.06525605833292, 161.2389108805313, 171.1627562645167, 175.77156629149303, 153.68928238952148, 146.97537909622784, 161.99687690544997, 133.7579657977746, 138.77845843600227, 156.35653687103184, 163.7920142031944, 156.14181011180762, 159.81374012573494, 168.49977760770335, 152.86693983397336, 153.48484823041298, 158.69067540824886, 169.03951311081335, 119.25447987807324, 150.32777085562498, 134.78046300449878, 146.0521789031264, 139.2043447575757, 175.56378378885637, 123.23277820577947, 149.09934376606955, 160.47708247058065, 148.97226033902487, 168.30024305287282, 151.40928048727105, 171.92273879599688, 148.37597971403085, 136.84507041337474, 139.25667181059293, 124.95716959120954, 153.8475110960001, 159.52700870499825, 144.30854202541977, 162.75459908709456, 122.83888365633159, 154.4615075294741, 158.10399425472062, 139.46540993981642, 162.96749817846646, 167.9164124284862, 170.28134678702256, 169.18768460389992, 167.71743221556022, 162.92699485275168, 172.46144152735562, 153.30973722287226, 151.27169014439767, 136.95395161337626, 147.50236483388596, 120.21990446221966, 118.40391455710186, 167.50596179334704, 151.89810570607042, 155.26827834955412, 152.33187430280142, 132.8444244096437, 159.2803897957248, 162.10822153885016, 131.43389029523604, 141.28648709863137, 132.20873900377276, 140.60765125789027, 175.09691663474962, 117.58396247288809, 122.67546429879157, 155.77058274997358, 147.42416161620667, 167.13921918265447, 166.89257061992691, 158.95157438749735, 126.29743608348637, 128.9720577624286, 166.94079097646144, 128.08464586441903, 147.48399152746262, 146.87148069260664, 162.2421028390876, 143.4077457034207, 118.92552821822763, 159.01122982955445, 152.72750596859666, 151.44562414838987, 119.08422201685224, 148.09449097693488, 146.3296001359132, 138.28798676628256, 136.22747219741657, 150.58519246156482, 152.27116326291127, 138.66132821832335, 158.08157923772458, 127.60823604238458, 147.56899780180026, 148.60992220154125, 167.8004463709571, 153.1145429561177, 174.0463009011537, 143.93784931317282, 129.40898672306312, 134.10889990738698, 163.284796399236, 149.14245546430223, 171.52535231186963, 156.32817777802933, 117.43812006968786, 122.1286661882808, 153.29453732056922, 142.92707872685068, 169.15829271801246, 155.39233168969866, 118.72124051825352, 161.44616349423418, 164.3608543311505, 156.61637472828193, 133.45026765684074, 158.5595445866749, 154.6792045207181, 145.84481435917107, 148.36373998354543, 146.93662355003792, 124.74067045061511, 162.03760819633618, 163.41397251151022, 135.0343317070171, 122.51198893097073, 168.16624473800658, 143.07451557813147, 123.78379462081189, 177.0636606320617, 132.15317527072173, 148.99638400177108, 126.74850772490836, 159.13987927365105, 141.11520116536062, 137.14650422121773, 134.04291422048559, 149.93550471234585, 129.19824086222937, 165.56588276993585, 146.7047550911411, 134.7204839826102, 138.0783598700125, 130.87104237027273, 125.05220941686781, 130.96391410152717, 160.96790753350234, 167.37437877391392, 150.90886613963377, 157.14667616694018, 145.5415556194464, 157.68651084161246, 161.31552144840185, 127.3531712840171, 154.12519535033437, 171.76361272259126, 123.0889212375722, 152.37134937993136, 142.8795862578783, 170.41719751190286, 139.39457797455609, 174.12496675746596, 143.66006443630812, 158.3630499149135, 125.6717655637722, 150.24386078145878, 147.7507205136954, 140.33250184129582, 167.34991024419688, 139.3499020766593, 171.3970028555539, 146.1099609040222, 160.7684524720923, 159.35031957047588, 163.27584005750197, 168.38365064441044, 144.56596557562207, 170.3102480100665, 159.53806361076758, 146.90210048783237, 166.96466570490458, 129.2972022103811, 143.89686967411822, 159.02477614044327, 142.69004635649242, 169.75037034961977, 155.45159487181897, 130.92223349021774, 139.87870762310982, 153.5591532172675, 174.75063195535012, 152.80235663017575, 160.36167482048802, 126.8518705859272, 117.38893148402785, 137.95083031718394, 127.301320483455, 149.9703700201655, 137.03561982844812, 147.15102624454462, 145.8421334852216, 118.191712660217, 142.98497349194906, 156.57756240424223, 151.65687548856542, 159.79895113077364, 147.6923919490453, 153.84358292771833, 161.07627385392433, 161.19648697596324, 166.18657388452803, 145.49236321543177, 156.72623971925435, 156.82033584788797, 159.65439976678738, 143.0835121815185, 142.41615754983133, 164.26452053995558, 151.51137270929704, 129.93139050048617, 177.2845331957286, 164.84628323895947, 173.2638085055501, 122.79410382448397, 158.77788743320178, 151.59595733707786, 164.96613128418548, 147.65804661382154, 155.99934229091963, 148.44368703178685, 135.6788296810719, 159.86338991690258, 118.45388713976097, 161.05987474686688, 151.97459638177415, 169.45666144261378, 156.87165986080197, 135.40287665621193, 147.83047223613565, 126.28426851401836, 167.32485196069862, 149.4634439103785, 152.26015312905284, 134.4153569105052, 177.42998863736202, 150.17204841678804, 162.82430453894617, 118.36545880190656, 165.46585039269414, 125.04003551099483, 144.02641665808153, 145.89156178102903, 158.34966727318346, 175.61721653766708, 159.9608379346318, 134.85489962182996, 128.4334107110652, 162.06691452261978, 156.51116094751347, 148.87047297713727, 162.34538099747795, 138.08215008998957, 168.9744576828416, 158.8374219843127, 148.12790219613402, 149.16843371933828, 146.6512332346434, 152.80476487478177, 127.98100542686032, 129.96786852008043, 146.09158837103476, 142.93362999810844, 125.32231469573266, 163.2757291850902, 160.74457633502527, 165.67448264905087, 143.12820973916442, 124.74572570659575, 151.52845628384844, 125.93599379465896, 156.44656453301496, 148.550875212596, 133.39711983566363, 141.3030347007508, 141.45334968116651, 173.89577839459574, 154.08308954022553, 157.71075330050766, 157.92789555742172, 146.88532662948643, 131.1069220879609, 163.6001016755343, 157.45932471917348, 150.66799766055502, 162.9745151839172, 150.76799300880552, 139.27035986885514, 150.55451888316688, 128.7948357806288, 130.87717126995992, 140.12147023675507, 150.67918059375359, 149.56545185680162, 125.92359073689944, 136.9770605609503, 125.02661204251692, 151.6793139924197, 140.68047643024212, 130.5734372316609, 129.03169731226234, 148.87841400559185, 140.44515178434605, 134.64014503506408, 144.70736923068097, 149.4453257486448, 155.02462741497243, 150.1093686375802, 122.87060358628791, 169.32809561373952, 123.38300265203613, 120.21374633056621, 148.36859798785943, 135.79952036001274, 172.71543808021266, 150.63944764970532, 148.2035151253351, 143.67230514998874, 116.42088070484473, 136.69353176650034, 141.95854942894437, 156.61674381272937, 129.65423469108924, 139.30330327361395, 171.38850535565902, 153.6086304332391, 127.11598970437657, 146.92747812902644, 171.23282706233513, 144.74575500261716, 142.8114231623644, 160.07308258051754, 173.1942698316107, 132.2310380632278, 173.43654178908824, 149.1027787857953, 137.6246800610489, 176.79636485499412, 173.8796060380968, 143.97545806360242, 144.7721245883815, 129.2249843165233, 141.33512011791532, 149.75039805273622, 143.7475056417878, 125.27796852805382, 159.11024304650854, 151.13122038241733, 169.97833446742604, 163.01687345734484, 127.070524132618, 138.94951845138732, 152.98032545913748, 150.749479660057, 139.9062530071497, 162.5674211749591, 176.93405206816126, 150.09094875240388, 175.61685819324546, 149.894935063982, 172.88142016988715, 115.10728837435016, 170.0662270544244, 130.35849121918702, 118.51682050857866, 149.25585291552557, 148.3148062711334, 123.85494741236947, 138.79908096846006, 158.56466713632736, 146.98312759146205, 135.90824522064838, 151.81293667531907, 125.37473285377905, 125.58381356090219, 116.15264375625712, 166.34857835999213, 126.59185789794924, 172.71794090185713, 176.97603584408512, 167.4089325454398, 152.1716660903079, 176.93492755037494, 124.79954751661315, 140.06276809889573, 160.4196374579119, 147.80923022360204, 154.2678892305828, 147.85035230419768, 152.44866193244198, 134.11630055624926, 149.3780083754123, 123.78315522439408, 128.25882386606227, 146.6048924498482, 159.41543921102667, 175.38299877732314, 143.89827464402478, 149.2932553380167, 115.00416620313027, 126.2514919780416, 116.04072699193148, 120.22563659454038, 162.4404043206668, 173.47213256147094, 157.6294125794856, 170.94167082577857, 166.62518447089172, 164.29525801956197, 151.17228386074004, 151.4097268316773, 158.0024673536422, 114.65024922035865, 151.85332562803617, 152.87662749371333, 132.47389449699534, 158.8009538585619, 156.5743887058228, 155.35394185731332, 166.0907885790264, 144.1308008833109, 126.86068949111251, 143.39692425146586, 140.04444780897467, 136.76064773374645, 152.01645445364622, 152.0563321739441, 131.24355830982623, 129.3602031067581, 172.59208230169213, 155.31607071917068, 145.56008560091152, 119.14748842231126, 134.58876001072636, 152.00796411843862, 145.11977707282853, 150.566575597819, 155.3621097226294, 149.13193617019576, 137.98591209578967, 156.6221368292298, 125.0866885712197, 156.32729665902198, 161.6887912562699, 173.45185357008043, 157.76404247369655, 131.452047875125, 151.2400481735471, 164.7126008978011, 135.79755721220974, 151.3631780593279, 152.74727457144712, 116.36607617588392, 167.7120237612559, 159.13149885397846, 154.30490018512947, 157.61778667792277, 170.30354568277454, 134.14164325838908, 120.0096071837684, 160.75764500706282, 137.60343674897348, 165.2549616434955, 150.7518342786851, 132.99277656649926, 137.87784883531117, 149.104933435958, 121.35063198989835, 172.77675769982034, 150.8825978382753, 175.09321533983032, 155.33812096774056, 168.9368413204219, 159.33316255025835, 143.14412328752456, 134.1545227728804, 177.16421755411096, 142.6741226260208, 154.46943654449467, 145.9115317500871, 152.76654092871192, 157.31467267699804, 168.21561008893408, 119.8383353558153, 169.3734605387007, 144.75071801047466, 122.75098422880473, 157.88545204211263, 143.96461296117388, 122.39317966501935, 143.91502788657414, 169.55108083124978, 158.308716244942, 131.83290822602982, 154.55129055131113, 141.0654311413012, 147.94777909598017, 165.80258089898612, 155.81497739136566, 140.90845032088754, 120.14218694171947, 135.966597221141, 132.396253847625, 167.33660495686524, 131.58025305506797, 139.09747808949436, 152.67328806047277, 177.3316135412029, 166.8993819828755, 145.93566506068439, 144.34863962267954, 168.06573913238577, 123.90579652177632, 150.38737092798857, 154.80709077668234, 130.94898663125426, 147.86923766329357, 149.2153558553417, 151.2261077516193, 152.8274814199433, 146.53427342691205, 137.41999350588947, 166.20764584045662, 124.20522242654245, 139.78456657967823, 146.63161687518178, 170.24296560164052, 131.60424402615467, 146.0393087532996, 157.95264014550523, 142.16848935864277, 161.19938435758905, 149.7168483477942, 120.16997618115485, 145.7956525550344, 150.67850391569036, 158.27329096641037, 122.05218580618325, 145.63097962246837, 144.55692854459676, 126.44273622558293, 117.86582004862555, 131.5304077175675, 151.6870076305644, 166.8913382521075, 146.8023745274787, 117.92967773760155, 151.37761081919675, 143.9536042915318, 134.7973435117788, 150.89594752926115, 130.3423100115458, 120.04845941471493, 148.92972463602786, 156.22245615697506, 162.88986064935045, 126.30441809307648, 152.07562980629913, 148.6768721464638, 137.05996071898988, 137.21819903195671, 128.15025830664055, 143.10829718457185, 149.55794460865047, 145.4136046300846, 151.59917556289406, 150.51705392832397, 156.51610237664974, 141.78997369182366, 142.66593891457282, 139.97052181049696, 141.03356864867376, 141.2430064973474, 115.9299587516183, 146.11589957610587, 144.5706621345807, 153.226545982654, 149.41396366016482, 136.85411792853836, 132.55362523954017, 147.3719656690823, 150.3077191706445, 132.9196419459954, 156.94342446419583, 142.67813607578532, 140.23540213827957, 153.2615367973068, 127.79372076239994, 153.26352835452886, 151.00969289580837, 131.33692374258706, 145.04218552300665, 124.22558362823203, 147.97960572062252, 143.15942462580153, 155.28135533801495, 151.44847972260402, 153.48316623362416, 136.44213694732647, 147.50797636910474, 137.77428337473327, 136.46234325604095, 155.97073971305235, 140.0788845471858, 147.53329350063424, 155.71418724437757, 152.4835364045478, 147.77340317749565, 132.03413394237649, 153.1906559371767, 154.37532502701296, 156.66043844610306, 134.812457802655, 137.97870326730188, 146.2950423212186, 149.7751878271366, 136.48803245903565, 156.39197931413455, 121.81942934292817, 154.71469593771215, 145.15097903830593, 151.7501613353856, 137.18625280226624, 136.86576506054902, 151.4560469438959, 118.58302188585945, 124.62683048609755, 174.24536828788172, 140.17728523200233, 154.42434561485211, 155.8316129039248, 123.35970926345708, 128.1658431740176, 142.64860787849915, 159.60768633859686, 115.38449817062585, 144.25945124193328, 147.82563514588767, 156.10571261991805, 173.30171056959776, 157.67404751763385, 168.54577920489544, 131.6955924031982, 137.63200965062546, 157.0542892505572, 150.38544152711407]
    print(len(exp))
    import pylab
    import matplotlib.pyplot as plt

    #We can generating some pdfs
    (sig,bg,x,bins) = create_expectations()
    #or we load some
    #(sig,bg,x) = load_expectations(options.SIGNAL, options.BG)

    #Plotting the pdfs for fun ;)
    plt.plot(x,np.array(sig)/0.45113011,'*r')
    plt.plot(x,np.array(bg)/0.45113011,'ob')

    #Here we set the number of events in our fake analysis using a
    #binned shape likelihood
    #fs = open(options.EVENTS,'r')
    #ev = pickle.load(fs)
    #fs.close()
#    N = len(ev) DANGER
    N = 7e3#20050.0
    N = 1689.
    llh = setup_llh(sig, bg, bins,  N, 2)
    #Since it's a binned likelihood we can histogram the events to
    #speed up llh evaluations
    llh.EnableHistogramedEvents()
    llh.EnablePoissonSampling() #<--- optimization
    #setting up the analysis
    analysis = MLSandboxPythonAccess.FeldmanCousinsAnalysis(llh = llh,
                                                            cl = 0.9, #confidence level (not really important yet)
                                                           )

    if (options.RANKS != None): #there are precomputed values available
        ranks = MLSandboxPythonAccess.FCRanks()
        ranks.load(options.RANKS)
        analysis.SetFCRanks(ranks)
    else: #everything needs to be recomputed
        analysis.ComputeRanks( n_experiments = options.NEXP, #Number of pseudo experiments (trials)
                           min_xi = options.MUMIN/N, #lower boundary of likelihood parameter for rank calculation
                           max_xi = options.MUMAX/N, #upper boundary likelihood parameter for rank calculation
                           n_steps = int(options.NSTEPS), #number of steps
                           n_threads = int(options.NTHREADS))
        analysis.ranks.save("ranks.dat")

    #Pybindings are still missing for the function which makes an ensemble of
    #pseudo experiments and computes limits,
    #To determine the median upper limit when assuming bg only
    #we do it explicitly in python for now.
    up_lim = list()
    down_lim = list()
    analysis.ranks.SetConfidenceLevel(0.9)
    for i in range(options.NEXP):
        #Generate a pseudo experiment with background only
        analysis.Sample(0)
        #Compute FC limits for this particular experiments
        (up, down) = analysis.ComputeLimits()
        #save them..
        up_lim.append(up)
        down_lim.append(down)


    print "=== Sensitivity ==="
    up_lim = sorted(up_lim)
    up_lim = np.array(up_lim)
    median_lim = np.median(up_lim)
    print("Median upper limit: %f"%(median_lim*N))
    for j in xrange(5):
        val, err = integrate.quad(stats.norm.pdf, -(j+1),j+1)
        print ("upwards %d sigma (%f): %f"%(j+1, val, np.percentile(up_lim, (val+(1.-val)/2)*100)*N))
    for j in xrange(5):
        val, err = integrate.quad(stats.norm.pdf, -(j+1),j+1)
        print ("downwards %d sigma (%f): %f"%(j+1, val, np.percentile(up_lim, ((1.-val)/2)*100)*N))

    print "=== Unblinding ==="

    # FAKE SAMPLING
    bw = (x[1]-x[0])/2.0
    sig_exp = MLSandboxPythonAccess.Distribution(sig, min(bins), max(bins), 14)
    bg_exp = MLSandboxPythonAccess.Distribution(bg, min(bins), max(bins), 461)
    sig_exp.SetCDFSampling(True)
    bg_exp.SetCDFSampling(True)
    bg
    fake = []

    n_sig = 0
    for z in xrange(int(N - n_sig)*1):
        t = bg_exp.Sample()
    for z in xrange(int(N - n_sig)):
        t = bg_exp.Sample()
        fake.append(t)
    for z in xrange(n_sig):
        t = sig_exp.Sample()
        fake.append(t)
    print("Bestfit:",analysis.minimizer.bestFitLLH)
    #Setting the fake events
    llh.SetEvents(np.array(exp))
    #Setting the real events
    #llh.SetEvents(np.array(exp))

    hist, bins = np.histogram(exp, len(x), (bins[0], 180))
    bincent = bins[:-1] + np.diff(bins)/2.0
    plt.plot(bincent, hist/N, 'go')

    plt.yscale('log')
    plt.figure()
    plt.plot(bincent, (np.array(bg)/sum(bg)) / (hist/N), 'go')



#Compute the limits of the unblinded sample
    (up, down) = analysis.ComputeLimits()
    print(up*N)
    print(up)
    print("Bestfit:",analysis.minimizer.bestFitLLH)
    #Extract the best fit.
    bestfit = analysis.minimizer.bestFit
    #searching fo
    i = 0
    n = len(up_lim)
    while(i<n and up_lim[i]<up):
        #print up_lim[i]
        i +=1
    #Computing the p-value
    p_value = 1-float(i)/len(up_lim)
    p_value_sigma = stats.norm.ppf(1.0 - p_value)
    print("Best fit: %f"%(bestfit*N))
    print("Unblinded upper limit: %f"%(up*N))
    print("p-value: %f"%p_value)
    print("sigma: %f"%p_value_sigma)
    print(max(up_lim*N))
    print(min(up_lim*N))
    plt.figure()
    hist, bins = np.histogram(np.array(up_lim), 50, (0, 0.05))
    bincent = bins[:-1] + np.diff(bins)/2.0
    plt.plot(bincent*N, hist, 'ro')

    plt.axvline(median_lim*N,color = 'black',linestyle = 'solid')

    hist, bins = np.histogram(np.array(down_lim), 50, (0, 0.05))
    bincent = bins[:-1] + np.diff(bins)/2.0
    plt.plot(bincent*N, hist, 'bo')


    plt.show()

if (__name__ == "__main__"):
  parser = OptionParser('usage: %prog [options]')
  parser.add_option("-o", "--output", action="store", type="string", default=None, dest="OUTPUT", help="destination for output")
  parser.add_option("-e", "--events", action="store", type="string", default=None, dest="EVENTS", help="pickled array of event-values")
  parser.add_option("-s", "--signal", action="store", type="string", default=None, dest="SIGNAL", help="pickled Signal PDF as NARRAY")
  parser.add_option("-b", "--background", action="store", type="string", default=None, dest="BG", help="pickled Background PDF as NARRAY")
  parser.add_option("-r", "--ranks", action="store", type="string", default=None, dest="RANKS", help="stored Ranks;load the file otherwise will be recomputed")
  #parser.add_option("--nevents", action="store", type="int", default=None, dest="NEVENTS", help="number of events")
  parser.add_option("--min_mu", action="store", type="float", default=0., dest="MUMIN", help="minimum number of inj signal events")
  parser.add_option("--max_mu", action="store", type="float", default=0., dest="MUMAX", help="maximum number of inj signal events")
  parser.add_option("--nexperiments", action="store", type="int", default=10000, dest="NEXP", help="number of pseudo-experiments")
  parser.add_option("--nsteps", action="store", type="int", default=None, dest="NSTEPS", help="number of steps between MINMU and MAXMU")
  parser.add_option("-j", action="store", type="int", default=1, dest="NTHREADS", help="use that many threads")
  (options,args) = parser.parse_args()

  if (options.NSTEPS==None):
    options.NSTEPS = options.MUMAX


  compute_sensitivity(options)
